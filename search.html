<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title id="title">Recherche | five_lives</title>

    <link rel="stylesheet" href="./assets/css/header.css" />
    <link rel="stylesheet" href="./assets/css/style.css" />
    <script src="./assets/js/header.js" defer></script>
    <link rel="shortcut icon" href="./assets/favicon.ico" type="image/x-icon">
    <style>
      main {
        max-width: 800px;
        margin: 0 auto;
        padding: 80px 20px 120px;
      }

      h1 {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 24px;
        color: var(--color);
      }

      .search-container {
        position: relative;
        max-width: 600px;
        margin: 0 auto 32px;
      }

      .search-input {
        width: 100%;
        padding: 16px 20px 16px 48px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: var(--input-bg);
        color: var(--color);
        font-size: 15px;
        transition: all 0.2s ease;
        outline: none;
      }

      .search-input::placeholder {
        color: var(--muted);
      }

      .search-input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-transluent);
      }

      .search-icon {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
        pointer-events: none;
      }

      .results {
        margin: 0 auto;
        max-width: 700px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .result-item {
        padding: 16px 20px;
        border-radius: var(--radius);
        background: var(--card-bg);
        border: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .article {
        background-color: var(--accent-transluent);
      }

      .result-item:hover {
        border-color: var(--accent);
        box-shadow: 0 4px 4px var(--accent-transluent);
      }

      .result-title {
        font-weight: 600;
        font-size: 15px;
        color: var(--color);
      }

      .result-litle {
        font-size: 13px;
        color: var(--muted);
        word-break: break-all;
      }

      .result-meta {
        font-size: 13px;
        color: var(--muted);
        margin-top:6px;
      }

      .no-results {
        text-align: center;
        padding: 20px;
        color: var(--muted);
        font-size: 14px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: var(--muted);
        font-style: italic;
      }

      @media (max-width: 600px) {
        .search-input {
          padding: 14px 16px 14px 44px;
          font-size: 14px;
        }
        .search-icon {
          left: 16px;
        }
        .result-item {
          padding: 14px 16px;
        }
      }
    </style>
  </head>

  <body>
    <div id="header"></div>

    <main>
      <h1>Rechercher sur five_lives</h1>

      <div class="search-container">
        <svg
          class="search-icon"
          viewBox="0 0 24 24"
          width="18"
          height="18"
          fill="none"
          stroke="currentColor"
          stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="Rechercher des outils, expériences..."
          autocomplete="off" />
      </div>

      <div id="results" class="results">
        <div class="loading">Chargement des données...</div>
      </div>
    </main>

    <div id="footer"></div>

    <script>
      // ======= DOM & état =======
      const resultsContainer = document.getElementById("results");
      const input = document.getElementById("searchInput");

      let pagesData = {};       // json.pages
      let newspaperData = [];  // json.newspaper (tableau d'articles)

      const urlParams = new URLSearchParams(window.location.search);
      const initialSearch = urlParams.get('s') || '';

      // ======= utilitaires =======
      function escapeHtml(unsafe) {
        return String(unsafe || '')
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function showLoading() {
        resultsContainer.innerHTML = '<div class="loading">Chargement des données...</div>';
      }

      function showNoResults(msg = 'Aucun résultat trouvé') {
        resultsContainer.innerHTML = `<div class="no-results">${escapeHtml(msg)}</div>`;
      }

      // Similarité (ta fonction d'origine, inchangée)
      function similarityScore(query, text) {
        if (!query || !text) return 0;
        query = query.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        text = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

        if (query === "*") return 200;
        if (text === query) return 200;
        if (text.includes(query)) return 100 + query.length * 2;

        let score = 0;
        const queryWords = query.split(/\s+/);
        for (const word of queryWords) {
          if (text.includes(word)) score += 20;
        }
        for (let i = 0; i < query.length - 1; i++) {
          if (text.includes(query.substr(i, 2))) score += 5;
        }
        return score;
      }

      // Convertit le champ `content` d'un article en texte brut (pour recherche/snippet)
      function contentToText(content) {
        if (content == null) return '';
        if (typeof content === 'string') return content;
        if (Array.isArray(content)) return content.map(contentToText).join(' ');
        if (typeof content === 'object') {
          const parts = [];
          for (const k of Object.keys(content)) {
            const v = content[k];
            if (Array.isArray(v)) {
              v.forEach(item => {
                if (Array.isArray(item)) parts.push(String(item[0] || ''));
                else parts.push(String(item || ''));
              });
            } else if (typeof v === 'object') {
              parts.push(contentToText(v));
            } else {
              parts.push(String(v || ''));
            }
          }
          return parts.join(' ');
        }
        return '';
      }

      function truncateText(str, max = 160) {
        if (!str) return '';
        str = str.replace(/\s+/g, ' ').trim();
        if (str.length <= max) return str;
        return str.slice(0, max - 1).trim() + '…';
      }

      // ======= construction des résultats =======
      function buildPageMatches(query) {
        if (!pagesData) return [];
        const q = query.trim();
        if (!q) return [];
        return Object.entries(pagesData)
          .flatMap(([path, terms]) => {
            const term = (terms && terms[0]) ? String(terms[0]) : '';
            const description = (terms && terms[1]) ? String(terms[1]) : '';
            const joined = (terms || []).join(' ');
            const score = Math.max(similarityScore(q, term) * 2, similarityScore(q, description), similarityScore(q, joined));
            if (score > 0) {
              return {
                type: 'page',
                path,
                title: term || path,
                description,
                score
              };
            }
            return null;
          })
          .filter(Boolean);
      }

      function buildArticleMatches(query) {
        if (!Array.isArray(newspaperData)) return [];
        const q = query.trim();
        if (!q) return [];
        return newspaperData.map(entry => {
          const title = entry.title || '';
          const date = entry.date || '';
          const mood = entry.mood || '';
          const contentText = contentToText(entry.content || {});
          const scoreTitle = similarityScore(q, title) * 2;
          const scoreContent = similarityScore(q, contentText);
          const scoreMood = similarityScore(q, mood);
          const score = Math.max(scoreTitle, scoreContent, scoreMood);
          return {
            type: 'article',
            id: entry.id,
            path: `newspaper.html?id=${encodeURIComponent(entry.id)}`,
            title,
            date,
            mood,
            snippet: truncateText(contentText, 160),
            score
          };
        }).filter(m => m.score > 0);
      }

      // ======= rendu =======
      function renderResults(matches) {
        if (!matches || matches.length === 0) { showNoResults(); return; }
        resultsContainer.innerHTML = '';
        matches.forEach(m => {
          const div = document.createElement('div');
          div.className = 'result-item ' + m.type;
          if (m.type === 'page') {
            div.innerHTML = `
              <div class="result-title">${escapeHtml(m.title)}</div>
              <div class="result-litle">${escapeHtml(m.description || '')}</div>
            `;
            div.onclick = () => { window.location.href = m.path; };
          } else if (m.type === 'article') {
            div.innerHTML = `
              <div class="result-title">${escapeHtml(m.title || 'Sans titre')} ${m.id ? '• #' + escapeHtml(m.id) : ''}</div>
              <div class="result-meta">${escapeHtml(m.date || '')} ${m.mood ? '• ' + escapeHtml(m.mood) : ''}</div>
              <div class="result-litle">${escapeHtml(m.snippet)}</div>
            `;
            div.onclick = () => { window.location.href = m.path; };
          }
          resultsContainer.appendChild(div);
        });
      }

      // ======= recherche principale =======
      function performSearch(query) {
        resultsContainer.innerHTML = '';
        if (!query || query.trim().length === 0) {
          document.querySelector("title").textContent = "Recherche | five_lives";
          resultsContainer.innerHTML = '';
          return;
        }
        document.querySelector("title").textContent = `${query} | Recherche | five_lives`;

        const pageMatches = buildPageMatches(query);
        const articleMatches = buildArticleMatches(query);

        // fusionner, trier par score, limiter
        const all = pageMatches.concat(articleMatches)
          .sort((a,b) => b.score - a.score)
          .slice(0, 20);

        if (all.length === 0) { showNoResults(); return; }
        renderResults(all);
      }

      // ======= initialisation : charger list.json =======
      showLoading();
      fetch("./list.json")
        .then(r => {
          if (!r.ok) throw new Error("Erreur de chargement");
          return r.json();
        })
        .then(json => {
          pagesData = json.pages || {};
          newspaperData = Array.isArray(json.newspaper) ? json.newspaper : [];

          // si q initiale dans l'URL
          if (initialSearch) {
            input.value = initialSearch;
            performSearch(initialSearch);
          } else {
            resultsContainer.innerHTML = '';
          }
        })
        .catch(error => {
          resultsContainer.innerHTML = `
            <div class="no-results">
              Erreur de chargement des données : ${escapeHtml(error.message)}
            </div>
          `;
        });

      // ======= UI : debounce input -> pushState -> search =======
      let debounceTimer;
      input.addEventListener("input", () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          const q = input.value.trim();
          const url = new URL(window.location.href);
          if (q) url.searchParams.set('s', q);
          else url.searchParams.delete('s');
          window.history.pushState({}, '', url);
          performSearch(q);
        }, 200);
      });

      // gérer retour arrière
      window.addEventListener('popstate', () => {
        const q = (new URLSearchParams(window.location.search)).get('s') || '';
        input.value = q;
        performSearch(q);
      });
    </script>
  </body>
</html>
